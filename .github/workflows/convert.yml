name: Update Subscription
on:
  push:
    paths:
      - 'nodes.txt'
      - '.github/workflows/convert.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: ğŸ” Debug - Check nodes.txt
        run: |
          # æ£€æŸ¥ nodes.txt æ˜¯å¦å­˜åœ¨ä¸”æœ‰å†…å®¹
          if [ ! -s nodes.txt ]; then
            echo "âŒ é”™è¯¯ï¼šnodes.txt æ˜¯ç©ºçš„ï¼è¯·å¡«å…¥èŠ‚ç‚¹é“¾æ¥ï¼"
            exit 1
          fi
          echo "âœ… nodes.txt æ£€æŸ¥é€šè¿‡ï¼Œå†…å®¹é¢„è§ˆï¼š"
          head -n 3 nodes.txt

      - name: Download Subconverter
        run: |
          wget -O subconverter.tar.gz https://github.com/tindy2013/subconverter/releases/download/v0.7.2/subconverter_linux64.tar.gz
          tar -zxf subconverter.tar.gz
          chmod +x subconverter/subconverter

      - name: Create Local Config (é˜²ç½‘ç»œæ‹¦æˆª)
        run: |
          # æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªæœ€ç®€å•çš„é…ç½®æ–‡ä»¶ï¼Œä¸ä¾èµ–è¿œç¨‹ä¸‹è½½
          echo "api_mode=true" > pref.ini
          echo "target=clash" >> pref.ini
          echo "url=nodes.txt" >> pref.ini
          echo "output=clash.yaml" >> pref.ini
          
          # ç®€å•çš„åˆ†æµè§„åˆ™é…ç½®
          echo "[Rules]" >> pref.ini
          echo "MATCH,DIRECT" >> pref.ini
          
          echo "âœ… æœ¬åœ°é…ç½®æ–‡ä»¶ pref.ini åˆ›å»ºæˆåŠŸ"

      - name: Generate Config
        run: |
          # å¯åŠ¨è½¬æ¢ (ä½¿ç”¨æœ¬åœ°æ–‡ä»¶è·¯å¾„)
          # æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä¸æŒ‡å®š --configï¼Œè®©å®ƒä½¿ç”¨é»˜è®¤æˆ–ç”Ÿæˆçš„é…ç½®
          ./subconverter/subconverter -g --target=clash --url=$(pwd)/nodes.txt --output=$(pwd)/clash.yaml

      - name: Check Result & Rename
        run: |
          if [ -f "clash.yaml" ]; then
            echo "âœ… æˆåŠŸç”Ÿæˆ clash.yaml"
            ls -lh clash.yaml
          else
            echo "âŒ ç”Ÿæˆå¤±è´¥ï¼å°è¯•æŸ¥çœ‹ subconverter ç›®å½•..."
            ls -R subconverter/
            exit 1
          fi

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add clash.yaml
          git commit -m "Auto update subscription" || echo "No changes to commit"
          git push
