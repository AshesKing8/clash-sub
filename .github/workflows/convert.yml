name: Convert nodes.txt to Clash Subscription

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 0 * * *'  # 每天自动运行一次

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Download nodes.txt
      run: |
        curl -L https://github.com/AshesKing8/clash-sub/raw/main/nodes.txt -o nodes.txt

    - name: Convert nodes.txt to Clash Subscription YAML
      run: |
        python3 <<EOF
import yaml

# 读取 nodes.txt 文件内容
with open('nodes.txt', 'r', encoding='utf-8') as f:
    nodes = f.readlines()

# 处理 nodes.txt 内容，将其转为 Clash 配置格式
clash_config = {
    'proxies': []
}

for node in nodes:
    # 假设每行是 '类型://地址'
    parts = node.strip().split('://')
    if len(parts) == 2:
        proxy = {
            'name': parts[1],  # 使用节点的地址作为名称
            'type': parts[0],  # 使用协议类型
            'server': parts[1],
            'port': 443,  # 默认端口
            'cipher': 'auto',  # 可以根据需要调整
            'password': 'your-password-here',  # 添加密码或其他必要配置
            'udp': True  # 启用 UDP 转发
        }
        clash_config['proxies'].append(proxy)

# 将生成的 Clash 配置写入 output.yaml
with open('clash_subscription.yaml', 'w', encoding='utf-8') as f:
    yaml.dump(clash_config, f, default_flow_style=False, allow_unicode=True)
EOF

    - name: Upload Clash Subscription
      uses: actions/upload-artifact@v2
      with:
        name: clash-subscription
        path: clash_subscription.yaml
