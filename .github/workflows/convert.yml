name: Update Subscription
on:
  push:
    paths:
      - 'nodes.txt'
      - '.github/workflows/convert.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download Subconverter
        run: |
          wget -O sub.tar.gz https://github.com/tindy2013/subconverter/releases/download/v0.7.2/subconverter_linux64.tar.gz
          tar -zxf sub.tar.gz
          chmod +x subconverter/subconverter

      - name: ğŸš€ Run Dual Servers (åŒæœåŠ¡å™¨æ¨¡å¼)
        run: |
          # 1. å¯åŠ¨ Python æœåŠ¡å™¨ï¼ŒæŠŠå½“å‰ç›®å½•å˜æˆ http://127.0.0.1:8000
          # è¿™æ · nodes.txt å°±å¯ä»¥é€šè¿‡ http://127.0.0.1:8000/nodes.txt è®¿é—®
          python3 -m http.server 8000 &
          
          # 2. å¯åŠ¨ Subconverter æœåŠ¡ (ç«¯å£ 25500)
          cd subconverter
          ./subconverter &
          
          # 3. ä¼‘æ¯ 5 ç§’ï¼Œç­‰å¾…ä¸¤ä¸ªæœåŠ¡å®Œå…¨å¯åŠ¨
          sleep 5
          
          # 4. è¿™é‡Œçš„é­”æ³•ï¼šè®© Subconverter (25500) å»æŠ“ Python (8000) çš„æ–‡ä»¶
          # ä½¿ç”¨ curl å°†ç»“æœä¿å­˜ä¸º clash.yaml
          curl -v "http://127.0.0.1:25500/sub?target=clash&url=http://127.0.0.1:8000/nodes.txt&insert=false&config=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Mini.ini" -o ../clash.yaml

      - name: Verify Result
        run: |
          if [ -s "clash.yaml" ]; then
            echo "âœ… æˆåŠŸï¼æ–‡ä»¶å¤§å°ï¼š"
            ls -lh clash.yaml
          else
            echo "âŒ å¤±è´¥ï¼šç”Ÿæˆçš„ clash.yaml æ˜¯ç©ºçš„æˆ–ä¸å­˜åœ¨"
            # æ‰“å°ä¸€ä¸‹ curl çš„é”™è¯¯æ—¥å¿—æˆ–è€…å°è¯•æ— é…ç½®è½¬æ¢
            echo "å°è¯•æ— é…ç½®å…œåº•è½¬æ¢..."
            curl -v "http://127.0.0.1:25500/sub?target=clash&url=http://127.0.0.1:8000/nodes.txt" -o clash.yaml
            if [ ! -s "clash.yaml" ]; then exit 1; fi
          fi

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add clash.yaml
          git commit -m "Auto update subscription" || echo "No changes to commit"
          git push
