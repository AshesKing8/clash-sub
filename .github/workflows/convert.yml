name: Update Subscription
on:
  push:
    paths:
      - 'nodes.txt'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download Subconverter
        run: |
          # 下载工具
          wget -O subconverter.tar.gz https://github.com/tindy2013/subconverter/releases/download/v0.7.2/subconverter_linux64.tar.gz
          # 解压
          tar -zxf subconverter.tar.gz
          # 给执行权限 (防止权限不足报错)
          chmod +x subconverter/subconverter

      - name: Generate Config
        run: |
          # 核心修复：把 --artifact 改为 --target，并确保使用绝对路径
          # 加上 acl4ssr 的规则配置，让分流更智能
          ./subconverter/subconverter -g --target=clash --url=$(pwd)/nodes.txt --output=$(pwd)/clash.yaml --config=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online.ini

      - name: Check if file exists
        run: |
          ls -l clash.yaml

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add clash.yaml
          # 如果文件没变化，就不提交，防止报错
          git commit -m "Auto update subscription" || echo "No changes to commit"
          git push
