name: Update Subscription
on:
  push:
    paths:
      - 'nodes.txt'
      - '.github/workflows/convert.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: ğŸ§¹ Clean nodes.txt (å…³é”®ä¿®å¤)
        run: |
          # å¼ºåˆ¶æ¸…æ´— Windows å›è½¦ç¬¦ï¼Œé˜²æ­¢å·¥å…·è¯»å–å¤±è´¥
          sed -i 's/\r$//' nodes.txt
          # æ£€æŸ¥æ–‡ä»¶å†…å®¹
          if [ ! -s nodes.txt ]; then
            echo "âŒ nodes.txt æ˜¯ç©ºçš„ï¼"
            exit 1
          fi
          echo "âœ… æ–‡ä»¶å·²æ¸…æ´—ï¼Œå‡†å¤‡è½¬æ¢"

      - name: Download Tool
        run: |
          wget -O sub.tar.gz https://github.com/tindy2013/subconverter/releases/download/v0.7.2/subconverter_linux64.tar.gz
          tar -zxf sub.tar.gz
          # èµ‹äºˆæ‰§è¡Œæƒé™
          chmod +x subconverter/subconverter

      - name: Move & Convert (è´´èº«è¿è¡Œ)
        run: |
          # 1. æŠŠ nodes.txt æ¬è¿›å·¥å…·ç›®å½•ï¼Œè·Ÿå·¥å…·æ”¾åœ¨ä¸€èµ·
          cp nodes.txt subconverter/nodes.txt
          
          # 2. è¿›å…¥ç›®å½•
          cd subconverter
          
          # 3. åŸåœ°è¿è¡Œ (ä¸ä½¿ç”¨ url å‚æ•°ï¼Œä½¿ç”¨ pipe ç®¡é“è¾“å…¥ï¼Œè¿™æ˜¯æœ€ç¨³çš„æ–¹æ³•)
          # æŠŠ nodes.txt çš„å†…å®¹â€œå–‚â€ç»™å·¥å…·
          cat nodes.txt | ./subconverter -g --target=clash --url="pipe" --output="clash.yaml"
          
          # 4. æ£€æŸ¥æ˜¯å¦ç”Ÿæˆ
          if [ -f "clash.yaml" ]; then
             echo "âœ… è½¬æ¢æˆåŠŸï¼"
             # æŠŠç”Ÿæˆçš„ clash.yaml æ¬å›é¡¹ç›®æ ¹ç›®å½•
             mv clash.yaml ../clash.yaml
          else
             echo "âŒ è½¬æ¢å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—..."
             exit 1
          fi

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add clash.yaml
          git commit -m "Auto update subscription" || echo "No changes to commit"
          git push
